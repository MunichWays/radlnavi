steps:
- name: 'python'
  script: |
    python -m pip install poetry
    cd backend
    poetry install
    mkdir geo
    wget https://download.geofabrik.de/europe/germany/bayern/oberbayern-latest.osm.pbf -O ./geo/oberbayern-latest.osm.pbf
    poetry run python src/build.py
    mv geo/geo.db /geo-store/geo.db
  volumes:
  - name: 'geo-store'
    path: '/geo-store'
  id: build-geo-store
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args: ['storage', 'cp', '/geo-store/geo.db', 'gs://radlnavi-overpass']
  volumes:
  - name: 'geo-store'
    path: '/geo-store'
  id: upload-geo-store
# - name: 'gcr.io/cloud-builders/docker'
#   args: ['build', '-t', 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/backend:$COMMIT_SHA', '-f', 'backend/Dockerfile', 'backend']
#   id: build-backend
# - name: 'gcr.io/cloud-builders/docker'
#   args: ['build', '--build-arg', 'VERSION=$TAG_NAME', '-t', 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/frontend:$COMMIT_SHA', '-f', 'frontend/Dockerfile', 'frontend']
#   waitFor: ['-']
#   id: build-frontend
# - name: 'gcr.io/cloud-builders/docker'
#   id: push-backend
#   args: ['push', 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/backend:$COMMIT_SHA']
#   waitFor:
#   - build-backend
# - name: 'gcr.io/cloud-builders/docker'
#   id: push-frontend
#   args: ['push', 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/frontend:$COMMIT_SHA']
#   waitFor:
#   - build-frontend
# - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
#   entrypoint: gcloud
#   id: deploy-backend
#   waitFor:
#   - push-backend
#   args:
#   - 'run'
#   - 'deploy'
#   - 'backend'
#   - '--image'
#   - 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/backend:$COMMIT_SHA'
#   - '--region'
#   - 'europe-north1'
# - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
#   entrypoint: gcloud
#   waitFor:
#   - push-frontend
#   - deploy-backend
#   args:
#   - 'run'
#   - 'deploy'
#   - 'frontend'
#   - '--image'
#   - 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/frontend:$COMMIT_SHA'
#   - '--region'
#   - 'europe-north1'
# images:
# - 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/backend:$COMMIT_SHA'
# - 'europe-north1-docker.pkg.dev/$PROJECT_ID/images/frontend:$COMMIT_SHA'
